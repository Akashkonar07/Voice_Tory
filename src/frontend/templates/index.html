<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VoiceTory - Single Page Application</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .navbar {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 1rem 2rem;
            box-shadow: 0 2px 20px rgba(0, 0, 0, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 1000;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
        }

        .navbar-brand {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 1.5rem;
            font-weight: 800;
            color: #667eea;
            text-decoration: none;
        }

        .navbar-nav {
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        .nav-link {
            color: #667eea;
            text-decoration: none;
            font-weight: 500;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            transition: all 0.3s ease;
        }

        .nav-link:hover {
            background: rgba(102, 126, 234, 0.1);
            color: #764ba2;
        }

        .nav-link.active {
            background: rgba(102, 126, 234, 0.2);
            color: #764ba2;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
        }

        .page {
            display: none;
        }

        .page.active {
            display: block;
        }

        .auth-container {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 24px;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.15);
            padding: 45px;
            max-width: 450px;
            margin: 2rem auto;
            text-align: center;
        }

        .logo {
            font-size: 2.5rem;
            margin-bottom: 1rem;
        }

        .title {
            color: #333;
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 1rem;
        }

        .subtitle {
            color: #666;
            font-size: 1rem;
            margin-bottom: 2rem;
        }

        .form-group {
            margin-bottom: 1.5rem;
            text-align: left;
        }

        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: #333;
        }

        .form-input {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e1e5e9;
            border-radius: 12px;
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        .form-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .btn {
            width: 100%;
            padding: 16px 32px;
            border: none;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 1rem;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: transparent;
            color: #667eea;
            border: 2px solid #667eea;
        }

        .btn-secondary:hover {
            background: #667eea;
            color: white;
        }

        .feature-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        .feature-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 2rem;
            margin-top: 2rem;
        }

        .feature-item {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            padding: 2rem;
            text-align: center;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease;
        }

        .feature-item:hover {
            transform: translateY(-5px);
        }

        .feature-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
        }

        .feature-title {
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 1rem;
            color: #333;
        }

        .feature-description {
            color: #666;
            margin-bottom: 1.5rem;
        }

        .alert {
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            text-align: center;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .loading {
            display: none;
            text-align: center;
            margin: 1rem 0;
        }

        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .hidden {
            display: none !important;
        }

        @media (max-width: 768px) {
            .navbar {
                padding: 1rem;
                flex-direction: column;
                gap: 1rem;
            }

            .navbar-nav {
                flex-wrap: wrap;
                justify-content: center;
            }

            .container {
                padding: 1rem;
            }

            .auth-container {
                padding: 30px;
                margin: 1rem;
            }
        }
    </style>
</head>
<body>
    <!-- Navigation Bar -->
    <nav class="navbar" id="navbar" style="display: none;">
        <a href="#" class="navbar-brand" onclick="showPage('dashboard')">
            <span>🎤</span>
            <span>Voice Tory</span>
        </a>
        <div class="navbar-nav">
            <a href="#" class="nav-link" onclick="showPage('dashboard')">Dashboard</a>
            <a href="#" class="nav-link" onclick="showPage('speech-to-text')">Speech to Text</a>
            <a href="#" class="nav-link" onclick="showPage('inventory')">Inventory</a>
            <a href="#" class="nav-link" onclick="logout()">Logout</a>
        </div>
    </nav>

    <div class="container">
        <!-- Login Page -->
        <div id="login-page" class="page active">
            <div class="auth-container">
                <div class="logo">🎤</div>
                <h1 class="title">Welcome Back</h1>
                <p class="subtitle">Sign in to your account</p>
                
                <div id="login-alert" class="alert hidden"></div>
                
                <form id="loginForm">
                    <div class="form-group">
                        <label class="form-label" for="loginEmail">Email</label>
                        <input type="email" id="loginEmail" class="form-input" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="loginPassword">Password</label>
                        <input type="password" id="loginPassword" class="form-input" required>
                    </div>
                    <button type="submit" class="btn btn-primary">Sign In</button>
                </form>
                
                <div class="loading" id="login-loading">
                    <div class="spinner"></div>
                    <p>Signing in...</p>
                </div>
                
                <p style="margin-top: 1rem; color: #666;">
                    Don't have an account? <a href="#" onclick="showPage('signup')" style="color: #667eea; text-decoration: none;">Sign up</a>
                </p>
            </div>
        </div>

        <!-- Signup Page -->
        <div id="signup-page" class="page">
            <div class="auth-container">
                <div class="logo">🎤</div>
                <h1 class="title">Create Account</h1>
                <p class="subtitle">Join Voice Tory and start managing your inventory with voice commands</p>
                
                <div id="signup-alert" class="alert hidden"></div>
                
                <form id="signupForm">
                    <div class="form-group">
                        <label class="form-label" for="signupName">Full Name</label>
                        <input type="text" id="signupName" class="form-input" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="signupEmail">Email</label>
                        <input type="email" id="signupEmail" class="form-input" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="signupPassword">Password</label>
                        <input type="password" id="signupPassword" class="form-input" required>
                    </div>
                    <button type="submit" class="btn btn-primary">Create Account</button>
                </form>
                
                <div class="loading" id="signup-loading">
                    <div class="spinner"></div>
                    <p>Creating account...</p>
                </div>
                
                <p style="margin-top: 1rem; color: #666;">
                    Already have an account? <a href="#" onclick="showPage('login')" style="color: #667eea; text-decoration: none;">Sign in</a>
                </p>
            </div>
        </div>

        <!-- Dashboard Page -->
        <div id="dashboard-page" class="page">
            <div class="feature-card">
                <h1 style="color: #333; text-align: center; margin-bottom: 2rem;">🎤 Welcome to Voice Tory</h1>
                <p style="color: #666; text-align: center; font-size: 1.1rem; margin-bottom: 2rem;">
                    Manage your inventory with the power of voice commands and AI-powered speech recognition.
                </p>
                
                <div class="feature-grid">
                    <div class="feature-item">
                        <div class="feature-icon">🎙️</div>
                        <h3 class="feature-title">Speech to Text</h3>
                        <p class="feature-description">Convert your speech to text instantly and process inventory commands naturally.</p>
                        <button class="btn btn-primary" onclick="showPage('speech-to-text')">Start Speech Recognition</button>
                    </div>
                    
                    <div class="feature-item">
                        <div class="feature-icon">📦</div>
                        <h3 class="feature-title">Inventory Management</h3>
                        <p class="feature-description">View, manage, and analyze your inventory with comprehensive dashboards.</p>
                        <button class="btn btn-primary" onclick="showPage('inventory')">Manage Inventory</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Speech to Text Page -->
        <div id="speech-to-text-page" class="page">
            <h1 style="color: white; text-align: center; margin-bottom: 2rem; font-size: 2.5rem;">🎤 Speech to Text</h1>
            
            <div class="feature-card">
                <div class="feature-icon">🎙️</div>
                <h3 style="text-align: center; margin-bottom: 1rem;">Voice Recognition</h3>
                <p style="text-align: center; color: #666; margin-bottom: 2rem;">Click the button below and start speaking. Your speech will be converted to text and processed for inventory commands.</p>
                
                <div style="text-align: center; margin-bottom: 2rem;">
                    <button id="recordBtn" class="btn btn-primary" style="width: auto; padding: 16px 32px; font-size: 1.1rem;">
                        🎤 Start Recording
                    </button>
                    <button id="stopBtn" class="btn btn-secondary" style="width: auto; padding: 16px 32px; font-size: 1.1rem; display: none;">
                        ⏹️ Stop Recording
                    </button>
                </div>
                
                <div id="speech-status" style="text-align: center; margin-bottom: 1rem; font-weight: 500;"></div>
                
                <div class="loading" id="speech-loading">
                    <div class="spinner"></div>
                    <p>Processing speech...</p>
                </div>
                
                <div style="margin-bottom: 2rem;">
                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 500; color: #333;">Recognized Text:</label>
                    <div id="recognizedText" style="background: #f8f9fa; border: 2px solid #e9ecef; border-radius: 8px; padding: 1rem; min-height: 100px; font-family: monospace; white-space: pre-wrap;"></div>
                </div>
                
                <div style="text-align: center;">
                    <button id="clearBtn" class="btn btn-secondary" style="width: auto; margin-right: 1rem;">Clear Text</button>
                    <button id="sendBtn" class="btn btn-primary" style="width: auto;">Process Command</button>
                </div>
            </div>
            
            <div class="feature-card">
                <h3 style="text-align: center; margin-bottom: 1rem;">📁 Upload Audio File</h3>
                <p style="text-align: center; color: #666; margin-bottom: 1rem;">Alternatively, you can upload an audio file for speech recognition.</p>
                
                <div style="text-align: center;">
                    <input type="file" id="fileInput" accept="audio/*" style="display: none;">
                    <label for="fileInput" class="btn btn-secondary" style="width: auto; cursor: pointer;">Choose Audio File</label>
                </div>
                
                <div id="file-status" style="text-align: center; margin-top: 1rem; color: #666;"></div>
            </div>
        </div>

        <!-- Inventory Page -->
        <div id="inventory-page" class="page">
            <h1 style="color: white; text-align: center; margin-bottom: 2rem; font-size: 2.5rem;">📦 Inventory Management</h1>
            
            <div class="feature-card">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                    <h3>Inventory Overview</h3>
                    <div>
                        <button class="btn btn-primary" onclick="loadInventory()" style="width: auto; margin-right: 1rem;">🔄 Refresh</button>
                        <button class="btn btn-secondary" onclick="exportInventory()" style="width: auto;">📊 Export</button>
                    </div>
                </div>
                
                <div class="loading" id="inventory-loading">
                    <div class="spinner"></div>
                    <p>Loading inventory data...</p>
                </div>
                
                <div id="inventory-content">
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 2rem;">
                        <div style="background: #f8f9fa; padding: 1rem; border-radius: 8px; text-align: center;">
                            <div style="font-size: 2rem; font-weight: bold; color: #667eea;" id="total-products">0</div>
                            <div style="color: #666;">Total Products</div>
                        </div>
                        <div style="background: #f8f9fa; padding: 1rem; border-radius: 8px; text-align: center;">
                            <div style="font-size: 2rem; font-weight: bold; color: #28a745;" id="total-value">$0</div>
                            <div style="color: #666;">Total Value</div>
                        </div>
                        <div style="background: #f8f9fa; padding: 1rem; border-radius: 8px; text-align: center;">
                            <div style="font-size: 2rem; font-weight: bold; color: #ffc107;" id="low-stock">0</div>
                            <div style="color: #666;">Low Stock</div>
                        </div>
                    </div>
                    
                    <div id="inventory-list" style="background: #f8f9fa; border-radius: 8px; padding: 1rem; min-height: 200px;">
                        <p style="text-align: center; color: #666;">No inventory data available. Click refresh to load data.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let currentPage = 'login';
        let recognition = null;
        let isRecording = false;
        
        // Page management
        function showPage(pageName) {
            // Hide all pages
            document.querySelectorAll('.page').forEach(page => {
                page.classList.remove('active');
            });
            
            // Show selected page
            document.getElementById(pageName + '-page').classList.add('active');
            
            // Update navigation
            document.querySelectorAll('.nav-link').forEach(link => {
                link.classList.remove('active');
            });
            
            // Update current page
            currentPage = pageName;
            
            // Show/hide navbar based on authentication
            updateNavigation();
            
            // Load page-specific data
            if (pageName === 'dashboard') {
                loadDashboardData();
            } else if (pageName === 'inventory') {
                loadInventory();
            }
        }
        
        function updateNavigation() {
            const navbar = document.getElementById('navbar');
            const sessionToken = localStorage.getItem('session_token');
            
            if (sessionToken && (currentPage === 'dashboard' || currentPage === 'speech-to-text' || currentPage === 'inventory')) {
                navbar.style.display = 'flex';
                
                // Update active nav link
                document.querySelectorAll('.nav-link').forEach(link => {
                    link.classList.remove('active');
                    if (link.textContent.toLowerCase().includes(currentPage.replace('-', ' '))) {
                        link.classList.add('active');
                    }
                });
            } else {
                navbar.style.display = 'none';
            }
        }
        
        function loadUserInfo() {
            const userName = localStorage.getItem('username');
            if (userName) {
                // Update user info in the UI if needed
                console.log('User:', userName);
            }
        }
        
        // Alert management
        function showAlert(page, message, type) {
            const alertElement = document.getElementById(page + '-alert');
            if (alertElement) {
                alertElement.textContent = message;
                alertElement.className = `alert alert-${type}`;
                alertElement.classList.remove('hidden');
                
                // Hide alert after 5 seconds
                setTimeout(() => {
                    alertElement.classList.add('hidden');
                }, 5000);
            }
        }
        
        function showLoading(page, show) {
            const loadingElement = document.getElementById(page + '-loading');
            if (loadingElement) {
                loadingElement.style.display = show ? 'block' : 'none';
            }
        }
        
        // Login functionality
        document.getElementById('loginForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const username = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            
            showLoading('login', true);
            
            try {
                const response = await fetch('/api/auth/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ username, password }),
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    localStorage.setItem('session_token', data.session_token);
                    localStorage.setItem('username', data.username);
                    localStorage.setItem('user_id', data.user_id);
                    showAlert('login', 'Login successful!', 'success');
                    setTimeout(() => {
                        showPage('dashboard');
                    }, 1000);
                } else {
                    showAlert('login', data.error || 'Login failed', 'error');
                }
            } catch (error) {
                showAlert('login', 'Network error. Please try again.', 'error');
            } finally {
                showLoading('login', false);
            }
        });
        
        // Signup functionality
        document.getElementById('signupForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const username = document.getElementById('signupName').value;
            const email = document.getElementById('signupEmail').value;
            const password = document.getElementById('signupPassword').value;
            const full_name = document.getElementById('signupName').value;
            
            showLoading('signup', true);
            
            try {
                const response = await fetch('/api/auth/signup', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ username, email, password, full_name }),
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    localStorage.setItem('session_token', data.session_token);
                    localStorage.setItem('username', data.username);
                    localStorage.setItem('user_id', data.user_id);
                    showAlert('signup', 'Account created successfully!', 'success');
                    setTimeout(() => {
                        showPage('dashboard');
                    }, 1000);
                } else {
                    showAlert('signup', data.error || 'Signup failed', 'error');
                }
            } catch (error) {
                showAlert('signup', 'Network error. Please try again.', 'error');
            } finally {
                showLoading('signup', false);
            }
        });
        
        // Logout functionality
        function logout() {
            const sessionToken = localStorage.getItem('session_token');
            
            if (sessionToken) {
                fetch('/api/auth/logout', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ session_token }),
                }).catch(() => {
                    // Ignore network errors during logout
                });
            }
            
            localStorage.removeItem('session_token');
            localStorage.removeItem('username');
            localStorage.removeItem('user_id');
            showPage('login');
        }
        
        // Speech recognition functionality
        function toggleSpeechRecognition() {
            if (isRecording) {
                stopRecording();
            } else {
                startSpeechToText();
            }
        }
        
        function startSpeechToText() {
            if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
                updateSpeechStatus('Speech recognition not supported in this browser. Please use Chrome, Edge, or Safari.', 'error');
                return;
            }
            
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            recognition = new SpeechRecognition();
            
            // Configure recognition for better sensitivity
            recognition.continuous = false;
            recognition.interimResults = true;
            recognition.lang = 'en-US';
            recognition.maxAlternatives = 1;
            
            // Increase timeout for better speech detection
            if (recognition.timeout) {
                recognition.timeout = 10000; // 10 seconds timeout
            }
            
            recognition.onstart = function() {
                isRecording = true;
                document.getElementById('recordBtn').style.display = 'none';
                document.getElementById('stopBtn').style.display = 'inline-block';
                updateSpeechStatus('Listening... Speak now', 'listening');
            };
            
            recognition.onresult = function(event) {
                let finalTranscript = '';
                let interimTranscript = '';
                
                for (let i = event.resultIndex; i < event.results.length; i++) {
                    const transcript = event.results[i][0].transcript;
                    if (event.results[i].isFinal) {
                        finalTranscript += transcript + ' ';
                    } else {
                        interimTranscript += transcript;
                    }
                }
                
                const currentText = document.getElementById('recognizedText').textContent;
                const newText = currentText + finalTranscript + interimTranscript;
                document.getElementById('recognizedText').textContent = newText;
                
                // Show interim results for better user feedback
                if (interimTranscript) {
                    updateSpeechStatus('Listening... ' + interimTranscript, 'listening');
                }
                
                // Process final results
                if (finalTranscript) {
                    updateSpeechStatus('Speech recognized successfully!', 'success');
                    // Send the recognized text to the server for processing/storage
                    sendTextToServer(newText);
                }
            };
            
            recognition.onerror = function(event) {
                console.error('Speech recognition error:', event.error);
                let errorMessage = 'Speech recognition failed. ';
                
                switch(event.error) {
                    case 'no-speech':
                        errorMessage += 'No speech was detected. Please speak clearly and try again.';
                        break;
                    case 'audio-capture':
                        errorMessage += 'Microphone access denied or no microphone found. Please check your microphone settings.';
                        break;
                    case 'not-allowed':
                        errorMessage += 'Microphone permission denied. Please allow microphone access and try again.';
                        break;
                    case 'network':
                        errorMessage += 'Network error occurred. Please check your internet connection.';
                        break;
                    case 'service-not-allowed':
                        errorMessage += 'Speech recognition service not available. Please try again later.';
                        break;
                    default:
                        errorMessage += 'Please try again.';
                }
                
                updateSpeechStatus(errorMessage, 'error');
                stopRecording();
            };
            
            recognition.onend = function() {
                if (isRecording) {
                    // Reset status after 3 seconds
                    setTimeout(() => {
                        updateSpeechStatus('🎤 Ready to listen - Click "Start Recording" and allow microphone access when prompted', 'ready');
                    }, 3000);
                }
                isRecording = false;
                document.getElementById('recordBtn').style.display = 'inline-block';
                document.getElementById('stopBtn').style.display = 'none';
            };
            
            try {
                recognition.start();
            } catch (error) {
                console.error('Error starting recognition:', error);
                updateSpeechStatus('Error starting speech recognition. Please try again.', 'error');
                isRecording = false;
            }
        }
        
        function stopRecording() {
            if (recognition) {
                recognition.stop();
                recognition = null;
            }
            
            isRecording = false;
            document.getElementById('recordBtn').style.display = 'inline-block';
            document.getElementById('stopBtn').style.display = 'none';
            updateSpeechStatus('Recording stopped', 'ready');
        }
        
        function updateSpeechStatus(message, type = 'ready') {
            const statusElement = document.getElementById('speech-status');
            if (statusElement) {
                statusElement.textContent = message;
                statusElement.style.color = type === 'error' ? '#dc3545' : 
                                       type === 'success' ? '#28a745' : 
                                       type === 'listening' ? '#ffc107' : '#667eea';
            }
        }
        
        function clearText() {
            document.getElementById('recognizedText').textContent = '';
            updateSpeechStatus('Text cleared', 'ready');
        }
        
        function sendTextToServer(text) {
            const sessionToken = localStorage.getItem('session_token');
            if (!sessionToken) {
                updateSpeechStatus('Session expired. Please log in again.', 'error');
                setTimeout(() => {
                    showPage('login');
                }, 2000);
                return;
            }
            
            showLoading('speech', true);
            
            fetch('/api/save-text', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${sessionToken}`,
                },
                body: JSON.stringify({
                    text: text,
                    timestamp: new Date().toISOString(),
                    source: 'microphone',
                    session_token: sessionToken
                }),
            })
            .then(response => {
                // Handle authentication errors
                if (response.status === 401) {
                    updateSpeechStatus('Session expired. Please log in again.', 'error');
                    setTimeout(() => {
                        showPage('login');
                    }, 2000);
                    throw new Error('Session expired');
                }
                
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    console.log('Text saved successfully');
                    
                    // Check if inventory was processed
                    if (data.inventory_processed) {
                        if (data.inventory_result && data.inventory_result.success) {
                            updateSpeechStatus('✅ Text saved and inventory updated successfully!', 'success');
                            
                            // Show inventory update details
                            const inventoryDetails = getInventoryUpdateMessage(data.inventory_result);
                            if (inventoryDetails) {
                                setTimeout(() => {
                                    updateSpeechStatus(inventoryDetails, 'success');
                                }, 2000);
                            }
                        } else {
                            updateSpeechStatus('⚠️ Text saved but inventory update failed: ' + (data.inventory_result?.error || 'Unknown error'), 'warning');
                        }
                    } else {
                        updateSpeechStatus('Text processed and saved successfully!', 'success');
                    }
                    
                    // Add success animation
                    const recognizedText = document.getElementById('recognizedText');
                    if (recognizedText) {
                        recognizedText.style.borderColor = '#4caf50';
                        setTimeout(() => {
                            if (recognizedText) {
                                recognizedText.style.borderColor = '#e0e0e0';
                            }
                        }, 2000);
                    }
                } else {
                    console.error('Failed to save text');
                    updateSpeechStatus('Failed to save text to server: ' + (data.message || 'Unknown error'), 'error');
                }
            })
            .catch(error => {
                if (error.message === 'Session expired') {
                    // Already handled above
                    return;
                }
                
                console.error('Error sending text to server:', error);
                
                if (error.message.includes('Failed to fetch')) {
                    updateSpeechStatus('Network error. Please check your internet connection.', 'error');
                } else {
                    updateSpeechStatus('Error sending text to server: ' + error.message, 'error');
                }
            })
            .finally(() => {
                showLoading('speech', false);
            });
        }
        
        function getInventoryUpdateMessage(result) {
            if (!result || !result.success) {
                return null;
            }
            
            const command = result.command || '';
            const product = result.product_name || '';
            const quantity = result.quantity || 0;
            
            switch (command) {
                case 'add':
                    return `📦 Added ${quantity} ${product}(s) to inventory`;
                case 'sell':
                    return `💰 Sold ${quantity} ${product}(s) from inventory`;
                case 'delete':
                    return `🗑️ Removed ${product} from inventory`;
                default:
                    return `✅ Inventory updated successfully`;
            }
        }
        
        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            // Validate session token
            const sessionToken = localStorage.getItem('session_token');
            if (!sessionToken) {
                updateSpeechStatus('Session expired. Please log in again.', 'error');
                setTimeout(() => {
                    showPage('login');
                }, 2000);
                return;
            }
            
            // Validate file type
            if (!file.type.startsWith('audio/')) {
                updateSpeechStatus('Please select an audio file', 'error');
                return;
            }
            
            // Check file size (max 10MB)
            if (file.size > 10 * 1024 * 1024) {
                updateSpeechStatus('File size too large. Please select a file smaller than 10MB.', 'error');
                return;
            }
            
            updateSpeechStatus('Processing audio file...', 'processing');
            
            const formData = new FormData();
            formData.append('audio_file', file);
            formData.append('session_token', sessionToken);
            
            showLoading('speech', true);
            
            fetch('/api/speech-to-text', {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${sessionToken}`
                },
                body: formData,
            })
            .then(response => {
                // Handle authentication errors
                if (response.status === 401) {
                    updateSpeechStatus('Session expired. Please log in again.', 'error');
                    setTimeout(() => {
                        showPage('login');
                    }, 2000);
                    throw new Error('Session expired');
                }
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    const currentText = document.getElementById('recognizedText').textContent;
                    const newText = currentText + (currentText ? ' ' : '') + (data.text || '');
                    document.getElementById('recognizedText').textContent = newText;
                    updateSpeechStatus('Audio file processed successfully', 'success');
                    
                    // Send the recognized text to the server for processing/storage
                    if (data.text) {
                        sendTextToServer(newText);
                    }
                } else {
                    updateSpeechStatus('Error processing audio file: ' + (data.message || data.error || 'Unknown error'), 'error');
                }
            })
            .catch(error => {
                if (error.message === 'Session expired') {
                    // Already handled above
                    return;
                }
                
                console.error('Error uploading audio file:', error);
                
                if (error.message.includes('Failed to fetch')) {
                    updateSpeechStatus('Network error. Please check your internet connection.', 'error');
                } else {
                    updateSpeechStatus('Error processing audio file: ' + error.message, 'error');
                }
            })
            .finally(() => {
                showLoading('speech', false);
                // Reset file input
                if (event.target) {
                    event.target.value = '';
                }
            });
        }
        
        // Dashboard functionality
        function loadDashboardData() {
            const sessionToken = localStorage.getItem('session_token');
            if (!sessionToken) {
                return;
            }
            
            showLoading('dashboard', true);
            
            fetch('/api/inventory/inventory', {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${sessionToken}`,
                },
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    updateDashboardStats(data.products || []);
                }
            })
            .catch(error => {
                console.error('Error loading dashboard data:', error);
            })
            .finally(() => {
                showLoading('dashboard', false);
            });
        }
        
        function updateDashboardStats(products) {
            const totalProducts = products.length;
            const totalValue = products.reduce((sum, product) => {
                return sum + (product.price * product.quantity);
            }, 0);
            const lowStock = products.filter(product => product.quantity < 10).length;
            const totalSales = products.reduce((sum, product) => {
                return sum + (product.total_sold || 0);
            }, 0);
            
            // Update dashboard stats if elements exist
            const totalProductsEl = document.getElementById('total-products');
            const totalValueEl = document.getElementById('total-value');
            const lowStockEl = document.getElementById('low-stock');
            const totalSalesEl = document.getElementById('total-sales');
            
            if (totalProductsEl) totalProductsEl.textContent = totalProducts;
            if (totalValueEl) totalValueEl.textContent = `$${totalValue.toFixed(2)}`;
            if (lowStockEl) lowStockEl.textContent = lowStock;
            if (totalSalesEl) totalSalesEl.textContent = totalSales;
        }
        
        // Inventory functionality
        function loadInventory() {
            const sessionToken = localStorage.getItem('session_token');
            if (!sessionToken) {
                alert('Please login first');
                return;
            }
            
            showLoading('inventory', true);
            
            fetch('/api/inventory/inventory', {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${sessionToken}`,
                },
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    displayInventory(data.products || []);
                } else {
                    alert('Error loading inventory: ' + (data.error || 'Unknown error'));
                }
            })
            .catch(error => {
                alert('Network error. Please try again.');
            })
            .finally(() => {
                showLoading('inventory', false);
            });
        }
        
        function displayInventory(products) {
            // Update statistics
            const totalProducts = products.length;
            const totalValue = products.reduce((sum, product) => sum + (product.price * product.quantity), 0);
            const lowStock = products.filter(product => product.quantity < 10).length;
            
            document.getElementById('total-products').textContent = totalProducts;
            document.getElementById('total-value').textContent = '$' + totalValue.toFixed(2);
            document.getElementById('low-stock').textContent = lowStock;
            
            // Update inventory list
            const inventoryList = document.getElementById('inventory-list');
            
            if (products.length === 0) {
                inventoryList.innerHTML = '<p style="text-align: center; color: #666;">No inventory data available.</p>';
                return;
            }
            
            let html = '<div style="display: grid; gap: 1rem;">';
            products.forEach(product => {
                html += `
                    <div style="background: white; padding: 1rem; border-radius: 8px; border-left: 4px solid ${product.quantity < 10 ? '#dc3545' : '#28a745'};">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <strong>${product.name}</strong>
                                <div style="color: #666; font-size: 0.9rem;">${product.category || 'Uncategorized'}</div>
                            </div>
                            <div style="text-align: right;">
                                <div style="font-weight: bold;">$${product.price}</div>
                                <div style="color: ${product.quantity < 10 ? '#dc3545' : '#28a745'};">Qty: ${product.quantity}</div>
                            </div>
                        </div>
                    </div>
                `;
            });
            html += '</div>';
            
            inventoryList.innerHTML = html;
        }
        
        function exportInventory() {
            const sessionToken = localStorage.getItem('session_token');
            if (!sessionToken) {
                alert('Please login first');
                return;
            }
            
            fetch('/api/inventory', {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${sessionToken}`,
                },
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const products = data.products || [];
                    let csv = 'Name,Category,Quantity,Price,Total Value\n';
                    
                    products.forEach(product => {
                        csv += `"${product.name}","${product.category || 'Uncategorized'}",${product.quantity},${product.price},${(product.price * product.quantity).toFixed(2)}\n`;
                    });
                    
                    const blob = new Blob([csv], { type: 'text/csv' });
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `inventory_${new Date().toISOString().split('T')[0]}.csv`;
                    a.click();
                    window.URL.revokeObjectURL(url);
                } else {
                    alert('Error exporting inventory: ' + (data.error || 'Unknown error'));
                }
            })
            .catch(error => {
                alert('Network error. Please try again.');
            });
        }
        
        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            const sessionToken = localStorage.getItem('session_token');
            
            if (sessionToken) {
                // Validate session token
                fetch('/api/auth/validate', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ session_token: sessionToken }),
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showPage('dashboard');
                        updateNavigation();
                        loadUserInfo();
                    } else {
                        // Invalid session, clear storage and show login
                        localStorage.removeItem('session_token');
                        localStorage.removeItem('username');
                        localStorage.removeItem('user_id');
                        showPage('login');
                    }
                })
                .catch(error => {
                    // Network error, assume invalid session
                    localStorage.removeItem('session_token');
                    localStorage.removeItem('username');
                    localStorage.removeItem('user_id');
                    showPage('login');
                });
            } else {
                showPage('login');
            }
            
            // Set up event listeners
            document.getElementById('recordBtn').addEventListener('click', toggleSpeechRecognition);
            document.getElementById('stopBtn').addEventListener('click', stopRecording);
            document.getElementById('clearBtn').addEventListener('click', clearText);
            document.getElementById('sendBtn').addEventListener('click', function() {
                const text = document.getElementById('recognizedText').textContent.trim();
                if (text) {
                    sendTextToServer(text);
                } else {
                    alert('Please record some text first');
                }
            });
            document.getElementById('fileInput').addEventListener('change', handleFileUpload);
        });
    </script>
</body>
</html>
